@{
    ViewData["Title"] = "Home Page";
}
<div class="text-center">
    <h1 class="display-4">Welcome</h1>
    <p>Learn about <a href="https://learn.microsoft.com/aspnet/core">building Web apps with ASP.NET Core</a>.</p>
    <div id="paypal-button-container"></div>
</div>

<form id="notificationForm">
    <input type="text" id="sessionCode" placeholder="Enter Session Code" required />
    <input type="text" id="title" placeholder="Enter Title" required />
    <input type="text" id="message" placeholder="Enter Message" required />
    <button type="button" onclick="sendNotification(false)">Send Notification</button>
</form>
<hr />
<button type="button" onclick="sendNotification(true)">Send All</button>

<script>
    subscribeUserToPush();
    const uniqueSessionCode = generateUniqueCode();
    async function subscribeUserToPush() {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            const registration = await navigator.serviceWorker.ready;
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: 'BCrjxLet8V4qp_p9Bp-ENACCp2Su2mcDCXnfqY1nkH8Ir63CMyLr1_FYFv87N6j2EfuC2KQ15EnJ5hYHUSiFfmk' //aaabc
            });
            const requestBody = JSON.stringify({ subscription, sessionCode: uniqueSessionCode });
            $.ajax({
                type: "POST",
                url: '/Home/Subscribe',
                data: { requestBody: requestBody },
                success: function (response) {

                },
                error: function (xhr, status, error) {
                    console.warn(error);
                    alert('error: is here');
                }
            });
            console.log('Subscribed:', subscription);
        }
    }
    function generateUniqueCode() {
        return 'xxxx-xxxx-xxxx-xxxx'.replace(/[x]/g, function () {
            return (Math.random() * 16 | 0).toString(16);
        });
    }

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
            .then(function (registration) {
                console.log('Service Worker registered with scope:', registration.scope);
            })
            .catch(function (error) {
                console.error('Service Worker registration failed:', error);
            });
    }

    async function sendNotification(isAll) {
        var sessionCode = '';
        if(document.getElementById('sessionCode').value != ''){
            sessionCode = document.getElementById('sessionCode').value;
        }
        const requestBody = JSON.stringify({ sessionCode: sessionCode, title: document.getElementById('title').value, message: document.getElementById('message').value, isAll: isAll });
        await fetch('/Home/SendNotification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: requestBody
        });
    }
</script>
